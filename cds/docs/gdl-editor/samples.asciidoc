= GDL Editor Samples
Rong Chen <rong.chen@cambio.se>, Iago Corbal <iago.corbal@cambio.se>
v0.93, 2014-12-09

FUNDED BY: Cambio Healthcare Systems (http://www.cambio.se)

== Body mass index calculation

This example will describe how to create a simple guideline to calculate the body mass index using the formula: 

image::img/samples/01_bmi-formula.jpg["Figure 1 - BMI ecuation", align="center"]

NOTE: The description of the guide should include all the necessary information to make sure it is used in the correct context.

To add a new rule, we click on the Add rule button. We include the name of the rule and hit Accept.

image::img/samples/02_creating_new_rule.jpg[title="Creating a new rule", align="center"]

After this step is performed, we will begin the rule editing. We should make sure that the elements needed have the correct units. We want to add two conditions: weight is measured in kilograms and height in centimeters. Double clicking twice on the Compare (Attribute) condition, we will add two empty conditions to the rule.

image::img/samples/03_adding_conditions.jpg[title="Adding conditions to specify units", align="center"]

Now we can specify the units for both elements we are going to obtain from the EHR (weight and height). Clicking on the Element attribute link, we can select the attribute we are going to use. Since we don’t have yet any archetypes defined on the guide, we will have to click on the Add archetype button to add an archetype reference (in this case Body Weight archetype, see Figure 4). Double click on the archetype or just select it and click on the Accept button. Once the archetype reference is added, we can select an element from it. Archetype references are stored in the definition section of the guideline and can be reused to select several elements from them (see Figure 5).

image::img/samples/04_select_element_instance.jpg[title="Select element instance", align="center"]

image::img/samples/05_adding_body_weight.jpg[title="Adding body weigh archetype reference", align="center"]

image::img/samples/06_selecting_element_instance.jpg[title="Selecting an element from the archetype", align="center"]

After selecting the element, we will be presented with a new dialog for selecting the attribute of the element (see Figure 6). We choose the units attribute and click Accept.

image::img/samples/07_selecting_attribute.jpg[title="Select attribute", align="center"]

Now we can select the operator and the units (kg) we want to specify.

image::img/samples/08_defining_units.jpg[title="Specifying kg units for body weight", align="center"]

We can do the same procedure for the archetype Height/Length, using the cm units.  Next we will need to specify that we are interested at calculating the BMI from only the most recent measurements of height and weight. To do so, we need go the definition tab (Figure 8). Double click on the Predicate (Function) and drag it inside the body_weight archetype instantiation. Once it is added, click on the element and select Event time. After selecting the element we set it at max so that it will always select the most recent measurement of weight. The same process can be repeated for the Height/Length archetype.

image::img/samples/09_predicate_function_for_weight.jpg[title="Predicate (Function) for Weight", align="center"]

Next we will need to add an action that will update the magnitude attribute of the element Body Mass Index archetype. We double click on the Action Set (Attribute), located at the lower panel. We follow the same steps as seem before for selecting units, but instead select magnitude attribute. By now, the rule should look like Figure 9.

image::img/samples/10_bmi_magnitude_selected.jpg[title="BMI magnitude selected", align="center"]

Last part requires defining the expression for calculating the BMI. We click on the Expression link to open the expression editor and enter the equation '(weight/( (height/100)^2) )'. Click on Accept button to add the expression to the action. 

NOTE: Expressions on current version must follow the pattern ‘(expression operator expression)’

image::img/samples/11_edit_expression_for_bmi.jpg[title="Expression for BMI calculation", align="center"]

We can now repeat the same task to set units and precision of the element calculated.

image::img/samples/12_bmi_actions.jpg[title="BMI calculation actions", align="center"]

Now the guide is ready for testing. We use the Run action to see if the rule is behaving properly.

image::img/samples/13_form_generator_for_bmi.jpg[title="Form generator calculating BMI", align="center"]

A final version of the GDL file can be found at <<Appendix_A>>.


== CHA2DS2-VASC Calculation

CHA2DS2-VASc is a clinical prediction score for estimating risk of stroke in patients with non -rheumatic atrial fibrillation (AF).

Following, is an example on how to create a guideline in GDL in order to perform this calculation automatically.

image::img/samples/14_cha2ds2-vasc_table.jpg[title="CHA2DS2-VASC table", align="center"]


=== Overview

Before we can begin building the GDL file for CHA2DS2-VASc, we need to create an archetype that will store the results of the different parameters that are needed for the calculation of the total score, as well as the result of the total score (Figure 14). The complete archetype defined can be found on Appendix B.

image::img/samples/15_overview_of_the _cha2ds2vasc_score_calculation_guideline.jpg[title="Overview of the CHA2DS2VASc Score calculation guideline", align="center"]

Once the archetype is ready we can start building the GDL file. The whole process is separated in 5 steps:
1.	Creating definitions
2.	Creating rules
3.	Creating preconditions
4.	Creating bindings
5.	Executing


=== Creating definitions

As shown in Figure 14 we need to instantiate two archetypes and one template (for each diagnosis).

We start first with the archetype that will store the results of the calculation.

To do so we double click (or click and drag) on “Archetype instantiation” and we select the openEHR-EHR-OBSERVATION.chadsvas_score.v1 archetype. Before clicking on “Accept” make sure to set the Domain to “CDS” since these will be data generated by GDL.

The next step is to instantiate the elements that will be used from this archetype. In this archetype we need all the available elements (except the “Event time”) so we click and drag “Element instantiation” and we place it inside the definition of openEHR-EHR-OBSERVATION.chadsvas_score.v1.

Next we click on “Element” and we select the first element in the list. We repeat the same process until the definition looks like in Figure 15.

image::img/samples/16_instantiation_of_openEHR-EHR-OBSERVATION.chadsvas_score.v1.jpg[title="Instantiation of openEHR-EHR-OBSERVATION.chadsvas_score.v1", align="center"]

The next archetype to instantiate is the openEHR-EHR-OBSERVATION.basic_demographic.v1. Once again we double click on “Archetype instantiation” and we select the archetype. Before clicking on “Accept” make sure that the Domain is set to “EHR” since these are data that in a normal setting would derive from the EHR record of a patient.

Next, repeat the same steps as before in order to instantiate the elements for “Birthdate” and “Gender”.

NOTE: Since we are probably going to be interested on the latest information regarding the gender and birthdate, we need to make sure that the guideline is including only the most recent data in the calculation. To do so we click and drag “Predicate (Function)” and we place it inside the definition of openEHR-EHR-OBSERVATION.basic_demographic.v1. Next, we click on “Element”, we select “Event time” and we set the operator to “max”.

The definition should look like in Figure 16.

image::img/samples/17_instantiation_of_openEHR-EHR-OBSERVATION.basic_demographic.v1.jpg[title="Instantiation of openEHR-EHR-OBSERVATION.basic_demographic.v1", align="center"]

Once the definition for the “basic_demographic” archetype is ready, we can start creating the definitions for the “diagnosis_icd10” template. Just as with the archetypes we double click on “Archetype instantiation” only this time we click on the “Templates” tab in the Archetypes/Templates window and we select the “diagnosis_icd10” template (Figure 17).

image::img/samples/18_instantiating_diagnosis_icd10_template.jpg[title="Instantiating diagnosis_icd10 template", align="center"]

Once we have finished instantiating the template we can instantiate the element of diagnosis from the template just as in the previous examples (Figure 18).

image::img/samples/19_diagnosis_instantiation.jpg[title="Diagnosis instantiation", align="center"]

NOTE: Because we are going to instantiate the template for each relevant diagnosis it is better that we rename the element of Diagnosis according to each diagnosis. To do so we click on “Diagnosis” (Figure 19) and we rename the element to Congestive heart failure diagnosis (we add the word diagnosis to the name in order to differentiate from the “Congestive heart failure” element of the “chadsvas_score” archetype) which is the first item on the CHA2DS2-VASc scale.

image::img/samples/20_renaming_diagnosis_to_congestive_heart_failure_diagnosis.jpg[title="Renaming Diagnosis to Congestive heart failure diagnosis", align="center"]

The following step is to specify that we are only interested on the instances that contain only congestive heart failure problems.

To filter all other problems we click and drag “Predicate (Data value)” inside the template definition. We click on the element, we select Diagnosis and we set the operator to “is_a”.

Lastly, we click on “DataValue” and on the next window we click on “Select term”. This will open a list with all the available local terms that we have created so far, and in there we select the “Congestive heart failure diagnosis” term (Figure 20).

image::img/samples/21_filtering_of diagnosis_using_predicate.jpg[title="Filtering of diagnosis using predicate", align="center"]

By now the definitions should look as in Figure 21.

image::img/samples/22_defined_archetypes_and_templates.jpg[title="Defined archetypes and templates", align="center"]

Repeat the same process for the rest of the diagnosis including atrial fibrillation until the definitions section looks like Figure 22.

image::img/samples/23_complete_definitions_list.jpg[title="Complete definitions list", align="center"]

Once we have finished creating the rest of the definitions we can start creating the rules for calculating each parameter as well as the total score.